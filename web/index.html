<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robotics Scheduler Visualizer</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --accent-color: #4cb5f5;
            --background-color: #f8f9fa;
            --text-color: #333;
            --light-gray: #e9ecef;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .input-section, .visualization-section {
            flex: 1;
            min-width: 300px;
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-gray);
            color: var(--secondary-color);
        }
        
        .scenario-selector {
            margin-bottom: 20px;
        }
        
        select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            margin-bottom: 15px;
        }
        
        textarea {
            min-height: 200px;
            resize: vertical;
            font-family: monospace;
        }
        
        .btn {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .btn-run {
            background-color: var(--accent-color);
            width: 100%;
            margin-top: 15px;
        }
        
        .btn-run:hover {
            background-color: #3a9bd8;
        }
        
        .visualization-container {
            width: 100%;
            height: 400px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            background-color: #f0f0f0;
        }
        
        #simulationCanvas {
            width: 100%;
            height: 100%;
        }
        
        .results-container {
            margin-top: 20px;
        }
        
        .result-item {
            background-color: var(--light-gray);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
        }
        
        .result-label {
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .control-btn {
            background-color: var(--light-gray);
            border: none;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
        }
        
        .control-btn:hover {
            background-color: #dde1e6;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #6c757d;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Robotics Scheduler</h1>
            <p class="subtitle">Multi-Robot Path Planning and Visualization</p>
        </header>
        
        <div class="main-content">
            <div class="input-section">
                <h2 class="section-title">Input Scenario</h2>
                
                <div class="scenario-selector">
                    <label for="scenarioSelect">Select a scenario:</label>
                    <select id="scenarioSelect">
                        <option value="">-- Custom Scenario --</option>
                        <option value="scenario_2_robots.txt">Basic 2 Robots</option>
                        <option value="scenario_3_robots.txt">Complex 3 Robots</option>
                        <option value="scenario_stress.txt">Stress Test</option>
                    </select>
                </div>
                
                <textarea id="scenarioInput" placeholder="Enter your scenario configuration here..."></textarea>
                
                <button class="btn btn-run" id="runBtn">Run Simulation</button>
            </div>
            
            <div class="visualization-section">
                <h2 class="section-title">Simulation Visualization</h2>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Running simulation...</p>
                </div>
                
                <div class="visualization-container">
                    <canvas id="simulationCanvas"></canvas>
                </div>
                
                <div class="controls">
                    <button class="control-btn" id="playBtn">▶️ Play</button>
                    <button class="control-btn" id="pauseBtn">⏸️ Pause</button>
                    <button class="control-btn" id="resetBtn">⏮️ Reset</button>
                    <input type="range" id="speedSlider" min="1" max="10" value="5">
                    <span id="speedValue">5x</span>
                </div>
                
                <div class="results-container" id="resultsContainer">
                    <div class="result-item">
                        <p><span class="result-label">Status:</span> <span id="statusText">Ready to run simulation</span></p>
                        <p><span class="result-label">Makespan:</span> <span id="makespanText">-</span></p>
                        <p><span class="result-label">Robots:</span> <span id="robotsText">-</span></p>
                        <p><span class="result-label">Operations:</span> <span id="operationsText">-</span></p>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Robo Hackathon Project - Multi-Robot Scheduling System</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const scenarioSelect = document.getElementById('scenarioSelect');
            const scenarioInput = document.getElementById('scenarioInput');
            const runBtn = document.getElementById('runBtn');
            const canvas = document.getElementById('simulationCanvas');
            const ctx = canvas.getContext('2d');
            const loading = document.getElementById('loading');
            const statusText = document.getElementById('statusText');
            const makespanText = document.getElementById('makespanText');
            const robotsText = document.getElementById('robotsText');
            const operationsText = document.getElementById('operationsText');
            const playBtn = document.getElementById('playBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const resetBtn = document.getElementById('resetBtn');
            const speedSlider = document.getElementById('speedSlider');
            const speedValue = document.getElementById('speedValue');
            
            // Canvas setup
            function resizeCanvas() {
                const container = canvas.parentElement;
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
            }
            
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            
            // Animation variables
            let animationId = null;
            let simulationData = null;
            let currentTime = 0;
            let isPlaying = false;
            let speed = 5;
            
            // Load scenario when selected
            scenarioSelect.addEventListener('change', async function() {
                if (this.value) {
                    try {
                        // In a real implementation, you would fetch the scenario content
                        // from your backend. For now, we'll use some example content.
                        const exampleScenarios = {
                            'scenario_2_robots.txt': `2 5 0.2 0.1 1.0 0.5\n0.0 0.0 0.0\n1.0 1.0 0.0\n2.0 2.0 0.0\n3.0 3.0 0.0\n4.0 4.0 0.0\n5.0 5.0 0.0\n6.0 6.0 0.0\n7.0 7.0 0.0\n8.0 8.0 0.0\n9.0 9.0 0.0`,
                            'scenario_3_robots.txt': `3 8 0.2 0.1 1.0 0.5\n0.0 0.0 0.0\n1.0 1.0 0.0\n2.0 2.0 0.0\n3.0 3.0 0.0\n4.0 4.0 0.0\n5.0 5.0 0.0\n6.0 6.0 0.0\n7.0 7.0 0.0\n8.0 8.0 0.0\n9.0 9.0 0.0\n10.0 10.0 0.0\n11.0 11.0 0.0\n12.0 12.0 0.0\n13.0 13.0 0.0\n14.0 14.0 0.0\n15.0 15.0 0.0`,
                            'scenario_stress.txt': `4 12 0.2 0.1 1.0 0.5\n0.0 0.0 0.0\n1.0 1.0 0.0\n2.0 2.0 0.0\n3.0 3.0 0.0\n4.0 4.0 0.0\n5.0 5.0 0.0\n6.0 6.0 0.0\n7.0 7.0 0.0\n8.0 8.0 0.0\n9.0 9.0 0.0\n10.0 10.0 0.0\n11.0 11.0 0.0\n12.0 12.0 0.0\n13.0 13.0 0.0\n14.0 14.0 0.0\n15.0 15.0 0.0\n16.0 16.0 0.0\n17.0 17.0 0.0\n18.0 18.0 0.0\n19.0 19.0 0.0\n20.0 20.0 0.0\n21.0 21.0 0.0\n22.0 22.0 0.0\n23.0 23.0 0.0`
                        };
                        
                        scenarioInput.value = exampleScenarios[this.value] || '';
                    } catch (error) {
                        console.error('Error loading scenario:', error);
                        alert('Failed to load scenario: ' + error.message);
                    }
                }
            });
            
            // Run simulation
            runBtn.addEventListener('click', async function() {
                const scenarioContent = scenarioInput.value.trim();
                
                if (!scenarioContent) {
                    alert('Please enter a scenario configuration.');
                    return;
                }
                
                loading.style.display = 'block';
                statusText.textContent = 'Running simulation...';
                
                try {
                    // Send request to your backend API
                    const response = await fetch('http://localhost:5000/api/run_scheduler', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            scenario: scenarioContent
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        statusText.textContent = 'Simulation completed successfully';
                        makespanText.textContent = data.makespan;
                        robotsText.textContent = data.metadata.num_robots;
                        operationsText.textContent = data.metadata.num_operations;
                        
                        // Parse the output for visualization
                        const parseResponse = await fetch('http://localhost:5000/api/parse_output', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                output_content: data.schedule
                            })
                        });
                        
                        if (parseResponse.ok) {
                            const parseData = await parseResponse.json();
                            if (parseData.success) {
                                simulationData = parseData.visualization_data;
                                resetSimulation();
                                drawSimulation();
                            }
                        }
                    } else {
                        throw new Error(data.error || 'Unknown error occurred');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    statusText.textContent = 'Error: ' + error.message;
                    alert('Error running simulation: ' + error.message);
                } finally {
                    loading.style.display = 'none';
                }
            });
            
            // Animation controls
            playBtn.addEventListener('click', function() {
                if (simulationData && !isPlaying) {
                    isPlaying = true;
                    animate();
                }
            });
            
            pauseBtn.addEventListener('click', function() {
                isPlaying = false;
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
            });
            
            resetBtn.addEventListener('click', resetSimulation);
            
            speedSlider.addEventListener('input', function() {
                speed = parseInt(this.value);
                speedValue.textContent = speed + 'x';
            });
            
            function resetSimulation() {
                isPlaying = false;
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                currentTime = 0;
                drawSimulation();
            }
            
            function drawSimulation() {
                if (!simulationData) return;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw grid
                const gridSize = 50;
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 1;
                
                for (let x = 0; x <= canvas.width; x += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                
                for (let y = 0; y <= canvas.height; y += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
                
                // Draw robots at current time
                const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFBE0B', '#FB5607', '#8338EC', '#3A86FF', '#04E762'];
                
                simulationData.robots.forEach((robot, index) => {
                    const color = colors[index % colors.length];
                    
                    // Draw path
                    if (robot.waypoints && robot.waypoints.length > 1) {
                        ctx.beginPath();
                        ctx.strokeStyle = color + '80'; // Semi-transparent
                        ctx.lineWidth = 2;
                        
                        const firstPoint = robot.waypoints[0];
                        ctx.moveTo(
                            firstPoint.x * gridSize + canvas.width / 2,
                            canvas.height / 2 - firstPoint.y * gridSize
                        );
                        
                        for (let i = 1; i < robot.waypoints.length; i++) {
                            const point = robot.waypoints[i];
                            ctx.lineTo(
                                point.x * gridSize + canvas.width / 2,
                                canvas.height / 2 - point.y * gridSize
                            );
                        }
                        
                        ctx.stroke();
                    }
                    
                    // Find current position
                    let currentPos = {x: 0, y: 0};
                    if (robot.waypoints && robot.waypoints.length > 0) {
                        if (currentTime <= robot.waypoints[0].time) {
                            currentPos = robot.waypoints[0];
                        } else if (currentTime >= robot.waypoints[robot.waypoints.length - 1].time) {
                            currentPos = robot.waypoints[robot.waypoints.length - 1];
                        } else {
                            for (let i = 0; i < robot.waypoints.length - 1; i++) {
                                if (currentTime >= robot.waypoints[i].time && currentTime <= robot.waypoints[i + 1].time) {
                                    const t = (currentTime - robot.waypoints[i].time) / 
                                             (robot.waypoints[i + 1].time - robot.waypoints[i].time);
                                    currentPos.x = robot.waypoints[i].x + t * (robot.waypoints[i + 1].x - robot.waypoints[i].x);
                                    currentPos.y = robot.waypoints[i].y + t * (robot.waypoints[i + 1].y - robot.waypoints[i].y);
                                    break;
                                }
                            }
                        }
                    }
                    
                    // Draw robot
                    ctx.fillStyle = color;
                    ctx.beginPath();
                    ctx.arc(
                        currentPos.x * gridSize + canvas.width / 2,
                        canvas.height / 2 - currentPos.y * gridSize,
                        10, 0, Math.PI * 2
                    );
                    ctx.fill();
                    
                    // Draw robot ID
                    ctx.fillStyle = '#000';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(
                        robot.id,
                        currentPos.x * gridSize + canvas.width / 2,
                        canvas.height / 2 - currentPos.y * gridSize
                    );
                });
                
                // Draw time
                ctx.fillStyle = '#000';
                ctx.font = '14px Arial';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';
                ctx.fillText(`Time: ${currentTime.toFixed(2)}s / ${simulationData.makespan.toFixed(2)}s`, 10, 10);
            }
            
            function animate() {
                if (!isPlaying || !simulationData) return;
                
                currentTime += 0.05 * speed;
                if (currentTime > simulationData.makespan) {
                    currentTime = simulationData.makespan;
                    isPlaying = false;
                }
                
                drawSimulation();
                animationId = requestAnimationFrame(animate);
            }
            
            // Initial draw
            drawSimulation();
        });
    </script>
</body>
</html>